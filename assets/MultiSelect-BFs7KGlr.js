import{a as e,d as t,o as n,r}from"./adminService-bkkylZxw.js";import{c as i}from"./chunk-4WY6JWTD-BE6XXGqj.js";const a=(e,t=null)=>{try{let n=localStorage.getItem(e);return n?JSON.parse(n):t}catch(e){return console.error(`Error reading from localStorage:`,e),t}},o=(e,t)=>{try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(e){return console.error(`Error writing to localStorage:`,e),!1}},s=e=>{try{return localStorage.removeItem(e),!0}catch(e){return console.error(`Error removing from localStorage:`,e),!1}},c={AUTH_TOKEN:`melodia_auth_token`,USER_DATA:`melodia_user_data`,VOLUME:`melodia_volume`,PLAYBACK_POSITION:`melodia_playback_position`,CURRENT_TRACK:`melodia_current_track`,QUEUE:`melodia_queue`,THEME:`melodia_theme`};var l=()=>{let e=a(c.AUTH_TOKEN)||localStorage.getItem(`token`);return e?{Authorization:`Bearer ${e}`}:{}},u=e=>{e.token&&localStorage.setItem(`token`,e.token),e.accountId&&(localStorage.setItem(`userId`,e.accountId),localStorage.setItem(`accountId`,e.accountId)),e.username&&localStorage.setItem(`username`,e.username),e.email&&localStorage.setItem(`email`,e.email),e.accountType&&(localStorage.setItem(`role`,e.accountType),localStorage.setItem(`accountType`,e.accountType))},d=e=>{let t={accountId:e.accountId,username:e.username,email:e.email,accountType:e.accountType};o(c.USER_DATA,t),e.token&&o(c.AUTH_TOKEN,e.token)},f=()=>{localStorage.removeItem(`token`),localStorage.removeItem(`userId`),localStorage.removeItem(`accountId`),localStorage.removeItem(`username`),localStorage.removeItem(`role`),localStorage.removeItem(`accountType`),localStorage.removeItem(`email`),localStorage.removeItem(`bio`),s(c.AUTH_TOKEN),s(c.USER_DATA)},p=e=>{try{let t=JSON.parse(atob(e.split(`.`)[1])).exp*1e3;return Date.now()>=t}catch(e){return console.error(`Error parsing token:`,e),!0}};const m={login:async(t,n)=>{try{let r=await e.post(`/auth/login`,{username:t,password:n});if(!r.ok){let e=`Login failed (${r.status})`;try{let t=await r.json();e=t.error||t.message||e}catch{r.status===401&&(e=`Invalid credentials`)}throw Error(e)}let i=await r.json(),a=i.data||i;if(!a.token)throw Error(`Authentication token missing`);if(!a.accountId)if(a.id)a.accountId=a.id;else if(a.userId)a.accountId=a.userId;else if(a.account_id)a.accountId=a.account_id;else throw Error(`Account ID missing from response`);return u(a),d(a),a}catch(e){throw console.error(`Login error:`,e),e}},register:async(t,n,r)=>{try{let i=await e.post(`/auth/register/user`,{username:t,email:n,password:r});if(!i.ok){let e=`Registration failed (${i.status})`;try{let t=await i.json();e=t.error||t.message||e}catch{e=`Registration failed`}throw Error(e)}let a=await i.json();return a.data||a}catch(e){throw console.error(`Registration error:`,e),e}},logout:async()=>{try{if(a(c.AUTH_TOKEN)||localStorage.getItem(`token`)){let t=await e.getURL();await fetch(`${t}/auth/logout`,{method:`POST`,headers:{...l()}})}}catch(e){console.error(`Logout request failed:`,e)}finally{f()}},validateToken:async()=>{let t=a(c.AUTH_TOKEN)||localStorage.getItem(`token`);if(!t)return!1;if(p(t))return f(),!1;try{let t=await e.getURL(),n=await fetch(`${t}/auth/validate`,{method:`GET`,headers:{...l()}});if(!n.ok)return f(),!1;let r=await n.json(),i=r.data||r;return u(i),d(i),!0}catch(e){return console.error(`Token validation error:`,e),f(),!1}},refreshToken:async()=>{try{let t=await e.getURL(),n=await fetch(`${t}/auth/refresh`,{method:`POST`,headers:{...l()}});if(!n.ok)throw f(),Error(`Token refresh failed`);let r=await n.json(),i=r.data||r;return u(i),d(i),i}catch(e){throw console.error(`Token refresh error:`,e),f(),e}},getCurrentUser:async()=>{try{let t=await e.get(`/auth/me`);if(!t.ok)return f(),null;let n=await t.json(),r=n.data||n;return u(r),d(r),r}catch(e){return console.error(`Get current user error:`,e),null}},checkExists:async t=>{try{let n=await(await e.get(`/auth/check/${t}`)).json();return(n.data||n).exists}catch(e){return console.error(`Check exists error:`,e),!1}},updateProfile:async t=>{try{let n={username:t.username,email:t.email},r=await e.put(`/auth/profile`,n);if(!r.ok){let e=`Update profile failed (${r.status})`;try{let t=await r.json();e=t.error||t.message||e}catch{}throw Error(e)}let i=await r.json(),a=i.data||i;return u(a),d(a),a}catch(e){throw console.error(`Update profile error:`,e),e}},changePassword:async(t,n,r)=>{try{let i=await e.post(`/auth/change-password`,{username:r,currentPassword:t,newPassword:n});if(!i.ok){let e=`Change password failed (${i.status})`;try{let t=await i.json();e=t.error||t.message||e}catch{}throw Error(e)}return i.json()}catch(e){throw console.error(`Change password error:`,e),e}},deleteAccount:async t=>{try{let n=await e.delete(`/auth/account/${t}`);if(!n.ok){let e=`Delete account failed (${n.status})`;try{let t=await n.json();e=t.error||t.message||e}catch{}throw Error(e)}return f(),!0}catch(e){throw console.error(`Delete account error:`,e),e}},isAuthenticated:()=>{let e=a(c.AUTH_TOKEN)||localStorage.getItem(`token`);return e?!p(e):!1},getToken:()=>a(c.AUTH_TOKEN)||localStorage.getItem(`token`)};var h=t(n(),1),g=()=>{let[e,t]=(0,h.useState)(null),[n,r]=(0,h.useState)(!1),[l,u]=(0,h.useState)(!0),[d,f]=(0,h.useState)(null),[p,g]=(0,h.useState)(`Initializing system...`),[_,v]=(0,h.useState)(0),y=i(),b=(0,h.useRef)(null),x=(0,h.useRef)(!1),S=(0,h.useCallback)(()=>{let e=m.getToken();if(!e)return!1;try{let t=JSON.parse(atob(e.split(`.`)[1])).exp*1e3;return!(Date.now()>=t)}catch(e){return console.error(`Error checking token expiry:`,e),!1}},[]),C=(0,h.useCallback)(async()=>{b.current&&=(clearInterval(b.current),null),g(`Session expired. Clearing data...`),v(50),s(c.AUTH_TOKEN),s(c.USER_DATA),localStorage.removeItem(`token`),localStorage.removeItem(`userId`),localStorage.removeItem(`accountId`),localStorage.removeItem(`username`),localStorage.removeItem(`role`),localStorage.removeItem(`accountType`),localStorage.removeItem(`email`),localStorage.removeItem(`bio`),t(null),r(!1),f(`Your session has expired. Please login again.`),g(`Redirecting to login...`),v(100),window.dispatchEvent(new CustomEvent(`auth:logout`)),y(`/auth`,{replace:!0})},[y]),w=(0,h.useCallback)(async()=>{try{u(!0),g(`Checking authentication...`),v(10);let e=a(c.AUTH_TOKEN),n=a(c.USER_DATA);if(!e){g(`No session found`),v(100),t(null),r(!1),u(!1);return}if(g(`Validating session token...`),v(30),await new Promise(e=>setTimeout(e,200)),!S()){g(`Session expired`),v(50),await C(),u(!1);return}if(!x.current){if(g(`Verifying credentials with server...`),v(50),!await m.validateToken()){g(`Invalid session`),v(70),await C(),u(!1);return}x.current=!0}if(g(`Loading user profile...`),v(70),await new Promise(e=>setTimeout(e,300)),n)g(`Welcome back, ${n.username}!`),v(90),t(n),r(!0),g(`Profile loaded successfully`),v(100);else{g(`Fetching user data...`),v(80);let e=await m.getCurrentUser();e?(g(`Welcome back, ${e.username}!`),v(95),t(e),r(!0),g(`Profile loaded successfully`),v(100)):(g(`Failed to load profile`),await C())}}catch(e){console.error(`Auth initialization error:`,e),f(`Failed to initialize authentication`),g(`Authentication failed`),v(100),t(null),r(!1)}finally{setTimeout(()=>{u(!1)},500)}},[S,C]);(0,h.useEffect)(()=>(b.current&&=(clearInterval(b.current),null),n&&e&&(b.current=setInterval(()=>{S()||C()},6e4)),()=>{b.current&&=(clearInterval(b.current),null)}),[n,e,S,C]),(0,h.useEffect)(()=>{w()},[w]),(0,h.useEffect)(()=>{let e=()=>{u(!0),g(`Refreshing session...`),v(0),w()};return window.addEventListener(`auth:refresh`,e),()=>window.removeEventListener(`auth:refresh`,e)},[w]),(0,h.useEffect)(()=>{let e=async()=>{if(document.visibilityState===`visible`&&n){if(!S()){await C();return}try{await m.validateToken()||await C()}catch(e){console.error(`Token validation error:`,e),await C()}}};return document.addEventListener(`visibilitychange`,e),()=>{document.removeEventListener(`visibilitychange`,e)}},[n,S,C]);let T=(0,h.useCallback)(async(e,n)=>{u(!0),f(null);try{g(`Authenticating...`),v(20);let i=await m.login(e,n);return g(`Verifying credentials...`),v(50),await new Promise(e=>setTimeout(e,200)),g(`Loading profile for ${i.username}...`),v(80),t(i),r(!0),g(`Login successful!`),v(100),window.dispatchEvent(new CustomEvent(`auth:refresh`)),{success:!0,user:i}}catch(e){return console.error(`Login error:`,e),f(e.message),g(`Login failed`),v(0),{success:!1,error:e.message}}finally{setTimeout(()=>{u(!1)},300)}},[]);return{user:e,isAuthenticated:n,isLoading:l,error:d,login:T,register:(0,h.useCallback)(async(e,t,n,r,i=``)=>{u(!0),f(null);try{g(`Creating account...`),v(20),await m.register(e,t,n,r,i),g(`Setting up profile...`),v(50),await new Promise(e=>setTimeout(e,200)),g(`Logging in...`),v(70);let a=await T(e,n);return a.success&&(g(`Registration complete!`),v(100)),a}catch(e){return console.error(`Registration error:`,e),f(e.message),g(`Registration failed`),v(0),{success:!1,error:e.message}}finally{setTimeout(()=>{u(!1)},300)}},[T]),logout:(0,h.useCallback)(async()=>{try{return g(`Logging out...`),v(30),b.current&&=(clearInterval(b.current),null),await m.logout(),g(`Clearing session data...`),v(70),s(c.AUTH_TOKEN),s(c.USER_DATA),t(null),r(!1),f(null),x.current=!1,g(`Logged out successfully`),v(100),window.dispatchEvent(new CustomEvent(`auth:refresh`)),window.dispatchEvent(new CustomEvent(`auth:logout`)),{success:!0}}catch(e){return console.error(`Logout error:`,e),g(`Logout completed with errors`),v(100),{success:!1,error:e.message}}},[]),updateProfile:(0,h.useCallback)(async n=>{u(!0),f(null);try{if(!n||Object.keys(n).length===0)throw Error(`No updates provided`);g(`Updating profile...`),v(30);let r=e?.accountType||`USER`,i=await m.updateProfile(n,r);return g(`Saving changes...`),v(70),o(c.USER_DATA,i),t(i),g(`Profile updated successfully`),v(100),{success:!0,user:i}}catch(e){let t=e.message||`Failed to update profile.`;return console.error(`Update profile error:`,t),f(t),g(`Update failed`),v(0),{success:!1,error:t}}finally{setTimeout(()=>{u(!1)},300)}},[e]),hasRole:(0,h.useCallback)(t=>e?.accountType===t||e?.role===t,[e]),clearError:(0,h.useCallback)(()=>{f(null)},[]),loadingMessage:p,loadingProgress:_}},_=t(r(),1),v=(0,h.createContext)(null);const y=({children:e})=>{let t=g(),n=(0,h.useMemo)(()=>({user:t.user,isAuthenticated:t.isAuthenticated,isLoading:t.isLoading,error:t.error,login:t.login,register:t.register,logout:t.logout,updateProfile:t.updateProfile,hasRole:t.hasRole,clearError:t.clearError,loadingMessage:t.loadingMessage,loadingProgress:t.loadingProgress}),[t.user,t.isAuthenticated,t.isLoading,t.error,t.login,t.register,t.logout,t.updateProfile,t.hasRole,t.clearError,t.loadingMessage,t.loadingProgress]);return(0,_.jsx)(v.Provider,{value:n,children:e})},b=()=>{let e=(0,h.useContext)(v);if(!e)throw Error(`useAuthContext must be used within an AuthProvider`);return e};var x=(0,h.createContext)(null);const S=({children:e})=>{let t=b(),n=(0,h.useMemo)(()=>({user:t.user,isAuthenticated:t.isAuthenticated,loading:t.isLoading,error:t.error,login:t.login,logout:t.logout,register:t.register,updateUser:t.updateProfile,hasRole:t.hasRole,clearError:t.clearError}),[t.user,t.isAuthenticated,t.isLoading,t.error,t.login,t.logout,t.register,t.updateProfile,t.hasRole,t.clearError]);return(0,_.jsx)(x.Provider,{value:n,children:e})},C=()=>{let e=(0,h.useContext)(x);if(!e)throw Error(`useUser must be used within UserProvider`);return e};var w=e=>e.replace(/([a-z0-9])([A-Z])/g,`$1-$2`).toLowerCase(),T=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,n)=>n?n.toUpperCase():t.toLowerCase()),E=e=>{let t=T(e);return t.charAt(0).toUpperCase()+t.slice(1)},D=(...e)=>e.filter((e,t,n)=>!!e&&e.trim()!==``&&n.indexOf(e)===t).join(` `).trim(),O=e=>{for(let t in e)if(t.startsWith(`aria-`)||t===`role`||t===`title`)return!0},k={xmlns:`http://www.w3.org/2000/svg`,width:24,height:24,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:2,strokeLinecap:`round`,strokeLinejoin:`round`},A=(0,h.forwardRef)(({color:e=`currentColor`,size:t=24,strokeWidth:n=2,absoluteStrokeWidth:r,className:i=``,children:a,iconNode:o,...s},c)=>(0,h.createElement)(`svg`,{ref:c,...k,width:t,height:t,stroke:e,strokeWidth:r?Number(n)*24/Number(t):n,className:D(`lucide`,i),...!a&&!O(s)&&{"aria-hidden":`true`},...s},[...o.map(([e,t])=>(0,h.createElement)(e,t)),...Array.isArray(a)?a:[a]])),j=(e,t)=>{let n=(0,h.forwardRef)(({className:n,...r},i)=>(0,h.createElement)(A,{ref:i,iconNode:t,className:D(`lucide-${w(E(e))}`,`lucide-${e}`,n),...r}));return n.displayName=E(e),n},M=j(`check`,[[`path`,{d:`M20 6 9 17l-5-5`,key:`1gmf2c`}]]),N=j(`chevron-down`,[[`path`,{d:`m6 9 6 6 6-6`,key:`qrunsl`}]]),P=j(`loader`,[[`path`,{d:`M12 2v4`,key:`3427ic`}],[`path`,{d:`m16.2 7.8 2.9-2.9`,key:`r700ao`}],[`path`,{d:`M18 12h4`,key:`wj9ykh`}],[`path`,{d:`m16.2 16.2 2.9 2.9`,key:`1bxg5t`}],[`path`,{d:`M12 18v4`,key:`jadmvz`}],[`path`,{d:`m4.9 19.1 2.9-2.9`,key:`bwix9q`}],[`path`,{d:`M2 12h4`,key:`j09sii`}],[`path`,{d:`m4.9 4.9 2.9 2.9`,key:`giyufr`}]]),F=j(`music`,[[`path`,{d:`M9 18V5l12-2v13`,key:`1jmyc2`}],[`circle`,{cx:`6`,cy:`18`,r:`3`,key:`fqmcym`}],[`circle`,{cx:`18`,cy:`16`,r:`3`,key:`1hluhg`}]]),I=j(`search`,[[`path`,{d:`m21 21-4.34-4.34`,key:`14j7rj`}],[`circle`,{cx:`11`,cy:`11`,r:`8`,key:`4ej97u`}]]),L=j(`upload`,[[`path`,{d:`M12 3v12`,key:`1x0j5s`}],[`path`,{d:`m17 8-5-5-5 5`,key:`7q97r8`}],[`path`,{d:`M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4`,key:`ih7n3h`}]]),R=j(`x`,[[`path`,{d:`M18 6 6 18`,key:`1bl5f8`}],[`path`,{d:`m6 6 12 12`,key:`d8bk6v`}]]),z={wrapper:`_wrapper_1lh8j_1`,label:`_label_1lh8j_15`,control:`_control_1lh8j_25`,disabled:`_disabled_1lh8j_65`,placeholder:`_placeholder_1lh8j_75`,value:`_value_1lh8j_83`,rightIcons:`_rightIcons_1lh8j_91`,icon:`_icon_1lh8j_103`,clearIcon:`_clearIcon_1lh8j_111`,error:`_error_1lh8j_127`,errorText:`_errorText_1lh8j_135`,dropdown:`_dropdown_1lh8j_145`,searchBox:`_searchBox_1lh8j_177`,searchIcon:`_searchIcon_1lh8j_219`,options:`_options_1lh8j_235`,option:`_option_1lh8j_235`,optionSelected:`_optionSelected_1lh8j_281`,checkbox:`_checkbox_1lh8j_289`,empty:`_empty_1lh8j_321`},B=({label:e,placeholder:t=`Select options`,values:n=[],options:r=[],onChange:i,disabled:a=!1,error:o})=>{let[s,c]=(0,h.useState)(!1),[l,u]=(0,h.useState)(``),d=(0,h.useRef)(null),f=r.filter(e=>n.includes(e.value)),p=(0,h.useMemo)(()=>{let e=l.toLowerCase();return r.filter(t=>t.label.toLowerCase().includes(e))},[r,l]),m=e=>{a||(n.includes(e)?i(n.filter(t=>t!==e)):i([...n,e]))},g=()=>{a||i([])};(0,h.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return document.addEventListener(`mousedown`,e),()=>document.removeEventListener(`mousedown`,e)},[]);let v=f.length===0?t:f.length===1?f[0].label:`${f[0].label} +${f.length-1} more`;return(0,_.jsxs)(`div`,{className:z.wrapper,ref:d,children:[e&&(0,_.jsx)(`label`,{className:z.label,children:e}),(0,_.jsxs)(`button`,{type:`button`,className:`${z.control} ${a?z.disabled:``} ${o?z.error:``}`,onClick:()=>!a&&c(e=>!e),children:[(0,_.jsx)(`span`,{className:f.length?z.value:z.placeholder,children:v}),(0,_.jsxs)(`div`,{className:z.rightIcons,children:[f.length>0&&!a&&(0,_.jsx)(R,{size:14,className:z.clearIcon,onClick:e=>{e.stopPropagation(),g()}}),(0,_.jsx)(N,{size:18,className:z.icon})]})]}),o&&(0,_.jsx)(`p`,{className:z.errorText,children:o}),s&&!a&&(0,_.jsxs)(`div`,{className:z.dropdown,children:[(0,_.jsxs)(`div`,{className:z.searchBox,children:[(0,_.jsx)(I,{size:14,className:z.searchIcon}),(0,_.jsx)(`input`,{type:`text`,placeholder:`Search genre...`,value:l,onChange:e=>u(e.target.value)})]}),(0,_.jsx)(`div`,{className:z.options,children:p.length===0?(0,_.jsx)(`div`,{className:z.empty,children:`No genres found`}):p.map(e=>{let t=n.includes(e.value);return(0,_.jsxs)(`button`,{type:`button`,className:`${z.option} ${t?z.optionSelected:``}`,onClick:()=>m(e.value),children:[(0,_.jsx)(`div`,{className:z.checkbox,children:t&&(0,_.jsx)(M,{size:14})}),(0,_.jsx)(`span`,{children:e.label})]},e.value)})})]})]})};export{F as a,j as c,y as d,b as f,I as i,S as l,R as n,P as o,m as p,L as r,M as s,B as t,C as u};